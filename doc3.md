## 5.文件处理

### 5.1 UNIX文件的概念

无论UNIX文件是什么程序创建的，都可以作为连续的字节流进行访问。

当你访问一个文件时，通过文件名打开它，操作系统会给你一个编号，称为文件描述符，你用它来只带该文件，直到使用完毕。
接下来你就可以使用文件描述符对该文件进行读取和写入。完成读取和写入后，关闭文件描述符即失效。

文件以下几个方面需要注意。
- 告诉Linux要打开文件的文件名，并以特定的模式打开（读取、写入、读写、如不存在的则创建等）
- - 通过open系统调用处理，所需参数为一个文件名、一个表示模式的数字以及一个权限集合
- - %eax将保存系统调用号----5
- - 文件名第一个字符的地址应该存放在%ebx中。
- - 以数字表示的读写意图应存放在%ecx中。现在，以0表示你想读的文件，以03101（必须包括最前面的0）表示你想要写的文件
- - 最后，权限集合应作为数字存储在%edx中（例如0666）
- 接着Linux将返回文件描述入到%eax。记住，你将在整个程序中用这个数字来指代这一文件
- 接下来，你会对文件进行操作：读取或写入文件，每次都要向Linx指明要使用的文件描述符
- - read是系统调用3，为了进行该调用，你必须将文件描述符存入%ebx，将存储数据的缓冲区地址存入%ecx中，将缓冲区大小放入%edx中。
- - read操作将返回从文件中读取的字符数，或一个错误代码。因为错误代码是负数，所以很容易区分。
- - write的系统调用是4，需要的参数和read系统调用相同，唯一的区别是，缓冲区应该已经填满了要写入的数据。
- - write系统调用将吧吸入的字节数或错误代码存入%eax
- 文件使用完毕，你就可以告诉Linux将其关闭以后你的文件描述入不再有效。
- - 这是通过close系统调用 6 来实现的。 close唯一的参数就是文件描述符，应该存储在 %ebx中


### 5.2 缓冲区和 .bss
缓冲区是连续的字节快，用于批量数据传输。当你要求读取文件时，操作系统需要有一个地方来存储读取的数据，这个地方就称为缓冲区。一般缓冲区仅用于暂时存储数据，然后数据被从缓冲区中读出并转换成便于程序处理的形式。

缓冲区的大小是固定的，由程序员设定。如果你想一次读入500字节的数据，可以将500字节未使用的内存位置的地址发送给read系统调用，并将数字500发送给他，这样read调用就知道数据的大小。数据可以根据应用程序的需求设定大小

要创建缓冲区，你需要保留静态或动态存储。静态存储就是我们目前位置所说的以 long或 .byte指令声明的存储位置。
不过用 .byte 声明缓冲区会存在问题。首先，你不得不在 .byte 声明后键入500个数字，而除了用于占用空间，这些数字没有任何用处。其次，这回占用可执行空间的位置。（这种做法会占用空间，浪费了可执行程序的空间）

.bss段类似于数据段，不同的是它不占用可执行程序空间。
.bss段可以保留存储位置，却不能对其进行初始化。在数据段中，你既可以保留存储位置，也能为其设置初始值；在.bss段中却不能设置初始值。对于缓冲区来说，这非常有用，因为我们并不需要初始化，只需要保留存储位置。
```
# 如下命令可以声明.bss段
.section .bss
.lcomm my_buffer, 500
```

.lcomm 指令将创建一个符号 my_buffer, 指代我们用作缓冲区的500字节存储位置。接着执行以下指令, 假定我们已经代开一个文件进行读取，并将文件描述符存放在%ebx中

```
movl $my_buffer, %ecx
movl 500, %edx
movl 3, %eax
int $0x80
```

上述指令将最多500字节的数据读入缓冲区。在本例中，我在my_buffer之前放置一个美元符号。这样做的原因是：若没有美元符号，my_buffer将被视为以直接寻址方式访问的内存位置。美元符号则将寻址方式变为立即寻址方式，实际上就是将my_buffer表示的数字本身（即缓冲区的起始地址，也就是my_buffer地址）加载到%ecx中


### 5.3 标准文件和特殊文件

Linux程序开始是至少有三个打开文件的描述符，分别是：
- STDIN     标准输入，是一个只读文件，通常代表键盘，为文件描述符0
- STDOUT    标准输出，是一个只写文件，通常代表屏幕显示，为文件描述符1
- STDERR    标准错误，是一个只写文件，通常代表屏幕显示，为文件描述符2

这些文件都可以重定向，以一个整整的文件取代屏幕或者键盘。

UNIX的操作系统把所有输入/输出系统都视作文件。


### 5.4 在程序中使用文件

.equ 指令允许你为数字分配名称

程序中使用文件代码如下
请参考 [toupper.s](/example/toupper.s)


### 5.5 温故知心